<?php

namespace Tests\Feature;

use App\Models\Account;
use App\Models\ContentDeclaration;
use App\Models\Role;
use App\Models\User;
use App\Models\WaiverVersion;
use App\Services\DgComplianceService;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

/**
 * API Tests — DG Module (FR-DG-001→009)
 * 20 tests covering all dangerous goods compliance endpoints.
 */
class DgComplianceApiTest extends TestCase
{
    use RefreshDatabase;

    private Account $account;
    private User $user;
    private WaiverVersion $waiver;

    protected function setUp(): void
    {
        parent::setUp();
        $this->account = Account::factory()->create();
        $role = Role::factory()->create(['account_id' => $this->account->id]);
        $this->user = User::factory()->create(['account_id' => $this->account->id, 'role_id' => $role->id]);
        $this->waiver = WaiverVersion::factory()->create();
    }

    // ── FR-DG-001: Create Declaration ────────────────────────

    /** @test */
    public function test_api_create_declaration(): void
    {
        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/declarations', ['shipment_id' => 'SH-API-001']);
        $r->assertStatus(201)->assertJsonPath('data.shipment_id', 'SH-API-001');
    }

    /** @test */
    public function test_api_create_declaration_validation(): void
    {
        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/declarations', []);
        $r->assertStatus(422);
    }

    /** @test */
    public function test_api_list_declarations(): void
    {
        $service = app(DgComplianceService::class);
        $service->createDeclaration($this->account->id, 'SH-LIST-1', $this->user->id);

        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/declarations');
        $r->assertOk();
    }

    /** @test */
    public function test_api_get_declaration(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-GET-1', $this->user->id);

        $r = $this->actingAs($this->user)->getJson("/api/v1/dg/declarations/{$decl->id}");
        $r->assertOk();
    }

    /** @test */
    public function test_api_get_shipment_declaration(): void
    {
        $service = app(DgComplianceService::class);
        $service->createDeclaration($this->account->id, 'SH-FOR-1', $this->user->id);

        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/shipments/SH-FOR-1/declaration');
        $r->assertOk();
    }

    // ── FR-DG-002: Set DG Flag ──────────────────────────────

    /** @test */
    public function test_api_set_dg_flag_no(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-FLAG-1', $this->user->id);

        $r = $this->actingAs($this->user)->postJson("/api/v1/dg/declarations/{$decl->id}/dg-flag", [
            'contains_dangerous_goods' => false,
        ]);
        $r->assertOk()->assertJsonPath('data.contains_dangerous_goods', false);
    }

    /** @test */
    public function test_api_set_dg_flag_yes(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-FLAG-2', $this->user->id);

        $r = $this->actingAs($this->user)->postJson("/api/v1/dg/declarations/{$decl->id}/dg-flag", [
            'contains_dangerous_goods' => true,
        ]);
        $r->assertOk()->assertJsonPath('data.status', 'hold_dg');
    }

    // ── FR-DG-003: Hold Info ────────────────────────────────

    /** @test */
    public function test_api_hold_info(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-HOLD-1', $this->user->id);
        $service->setDgFlag($decl->id, true, $this->user->id);

        $r = $this->actingAs($this->user)->getJson("/api/v1/dg/declarations/{$decl->id}/hold-info");
        $r->assertOk()->assertJsonPath('data.is_blocked', true);
    }

    /** @test */
    public function test_api_list_blocked(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-BLOCKED', $this->user->id);
        $service->setDgFlag($decl->id, true, $this->user->id);

        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/blocked');
        $r->assertOk();
    }

    // ── FR-DG-004: Accept Waiver ────────────────────────────

    /** @test */
    public function test_api_accept_waiver(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-WAIVER-1', $this->user->id);
        $service->setDgFlag($decl->id, false, $this->user->id);

        $r = $this->actingAs($this->user)->postJson("/api/v1/dg/declarations/{$decl->id}/accept-waiver");
        $r->assertOk()->assertJsonPath('data.waiver_accepted', true)->assertJsonPath('data.status', 'completed');
    }

    // ── FR-DG-007: Validate for Issuance ────────────────────

    /** @test */
    public function test_api_validate_issuance_success(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-VALID-1', $this->user->id);
        $service->setDgFlag($decl->id, false, $this->user->id);
        $service->acceptWaiver($decl->id, $this->user->id);

        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/validate-issuance', ['shipment_id' => 'SH-VALID-1']);
        $r->assertOk()->assertJsonPath('data.valid', true);
    }

    /** @test */
    public function test_api_validate_issuance_no_declaration(): void
    {
        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/validate-issuance', ['shipment_id' => 'SH-NONE']);
        $r->assertStatus(422)->assertJsonPath('valid', false);
    }

    /** @test */
    public function test_api_validate_issuance_dg_hold(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-HOLD-V', $this->user->id);
        $service->setDgFlag($decl->id, true, $this->user->id);

        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/validate-issuance', ['shipment_id' => 'SH-HOLD-V']);
        $r->assertStatus(422);
    }

    // ── FR-DG-009: DG Metadata ──────────────────────────────

    /** @test */
    public function test_api_save_dg_metadata(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-META-1', $this->user->id);

        $r = $this->actingAs($this->user)->postJson("/api/v1/dg/declarations/{$decl->id}/metadata", [
            'un_number' => 'UN3481', 'dg_class' => '9', 'quantity' => 1.5,
        ]);
        $r->assertOk()->assertJsonPath('data.un_number', 'UN3481');
    }

    // ── FR-DG-006: Waiver Version Management ────────────────

    /** @test */
    public function test_api_publish_waiver(): void
    {
        $r = $this->actingAs($this->user)->postJson('/api/v1/dg/waivers', [
            'version' => '2.0', 'locale' => 'en', 'waiver_text' => 'New legal text.',
        ]);
        $r->assertStatus(201)->assertJsonPath('data.version', '2.0');
    }

    /** @test */
    public function test_api_active_waiver(): void
    {
        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/waivers/active?locale=ar');
        $r->assertOk();
    }

    /** @test */
    public function test_api_list_waivers(): void
    {
        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/waivers?locale=ar');
        $r->assertOk();
    }

    // ── FR-DG-005: Audit Log ────────────────────────────────

    /** @test */
    public function test_api_audit_log(): void
    {
        $service = app(DgComplianceService::class);
        $decl = $service->createDeclaration($this->account->id, 'SH-AUDIT-1', $this->user->id);

        $r = $this->actingAs($this->user)->getJson("/api/v1/dg/declarations/{$decl->id}/audit-log");
        $r->assertOk();
    }

    /** @test */
    public function test_api_export_audit_log(): void
    {
        $service = app(DgComplianceService::class);
        $service->createDeclaration($this->account->id, 'SH-EXPORT-1', $this->user->id);

        $r = $this->actingAs($this->user)->getJson('/api/v1/dg/audit-log/export');
        $r->assertOk();
    }
}
